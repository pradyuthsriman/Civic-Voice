<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Civic Voice</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
Â  Â  :root {
Â  Â  Â  Â  --primary-color: #4CAF50;
Â  Â  Â  Â  --background-color: #f0f2f5;
Â  Â  Â  Â  --card-background: #ffffff;
Â  Â  Â  Â  --text-color: #333333;
Â  Â  Â  Â  --border-color: #e0e0e0;
Â  Â  }
Â  Â  body {
Â  Â  Â  Â  font-family: 'Poppins', sans-serif;
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  background: var(--background-color);
Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  min-height: 100vh;
Â  Â  }
Â  Â  .container {
Â  Â  Â  Â  max-width: 800px;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  margin-top: 50px;
Â  Â  }
Â  Â  h1, h2 {
Â  Â  Â  Â  color: var(--primary-color);
Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  margin-top: 0;
Â  Â  }
Â  Â  p {
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  font-weight: 400;
Â  Â  }
Â  Â  .card {
Â  Â  Â  Â  background: var(--card-background);
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
Â  Â  Â  Â  margin-bottom: 30px;
Â  Â  }
Â  Â  /* Landing & Registration Page */
Â  Â  #registrationPage, #mainAppPage {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  min-height: 80vh;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  transition: opacity 0.5s ease-in-out;
Â  Â  Â  Â  padding: 20px;
Â  Â  }
Â  Â  .main-title {
Â  Â  Â  Â  font-size: 3rem;
Â  Â  Â  Â  font-weight: 700;
Â  Â  }
Â  Â  .subtitle {
Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  }
Â  Â  .landing-options {
Â  Â  Â  Â  margin-top: 40px;
Â  Â  }
Â  Â  .landing-options button, #registerBtn {
Â  Â  Â  Â  background-color: var(--primary-color);
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  padding: 15px 30px;
Â  Â  Â  Â  margin: 10px;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: transform 0.2s, background-color 0.2s;
Â  Â  }
Â  Â  .landing-options button:hover, #registerBtn:hover {
Â  Â  Â  Â  background-color: #388E3C;
Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  }
Â  Â  #usernameInput {
Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  width: 300px;
Â  Â  }
Â  Â  /* Common Form & Feed Styles */
Â  Â  .section-container {
Â  Â  Â  Â  display: none;
Â  Â  Â  Â  padding: 20px 0;
Â  Â  }
Â  Â  .back-button {
Â  Â  Â  Â  background: #ccc;
Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  padding: 8px 15px;
Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  }
Â  Â  .location-btn-container {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  Â  align-items: center;
Â  Â  }
Â  Â  .location-btn-container input {
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  margin-right: 5px;
Â  Â  }
Â  Â  .location-btn-container button {
Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  padding: 0 15px;
Â  Â  Â  Â  height: 44px;
Â  Â  }
Â  Â  input[type="text"], select {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  margin: 8px 0;
Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  font-family: 'Poppins', sans-serif;
Â  Â  Â  Â  font-size: 14px;
Â  Â  }
Â  Â  #camera {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  border: 1px dashed var(--border-color);
Â  Â  Â  Â  background-color: #f5f5f5;
Â  Â  }
Â  Â  #photoPreview {
Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  max-height: 250px;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  display: none;
Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  }
Â  Â  .issue {
Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  background: var(--card-background);
Â  Â  Â  Â  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
Â  Â  }
Â  Â  .issue img {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  max-width: 300px;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  margin-top: 15px;
Â  Â  }
Â  Â  .voting-controls {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  margin-top: 15px;
Â  Â  }
Â  Â  .voting-controls button {
Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  background: #f0f2f5;
Â  Â  Â  Â  color: var(--text-color);
Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  transition: background-color 0.2s;
Â  Â  }
Â  Â  .voting-controls button:hover {
Â  Â  Â  Â  background: #e0e0e0;
Â  Â  }
</style>
</head>
<body>

<div class="container">
Â  Â  <div id="registrationPage">
Â  Â  Â  Â  <h1 class="main-title">Civic Voice</h1>
Â  Â  Â  Â  <p class="subtitle">Please enter your details to register.</p>
Â  Â  Â  Â  <input type="text" id="usernameInput" placeholder="Enter your username">
Â  Â  Â  Â  <input type="email" id="emailInput" placeholder="Enter your email">
Â  Â  Â  Â  <input type="tel" id="phoneInput" placeholder="Enter your phone number">
Â  Â  Â  Â  <button id="registerBtn" onclick="registerUser()">Register</button>
Â  Â  </div>

Â  Â  <div id="mainAppPage" style="display: none;">
Â  Â  Â  Â  <h1 class="main-title">Civic Voice</h1>
Â  Â  Â  Â  <p class="subtitle">Welcome, <span id="userNameDisplay">User</span>!</p>
Â  Â  Â  Â  <div class="landing-options">
Â  Â  Â  Â  Â  Â  <button onclick="showPage('submitIssuePage')">Upload an Issue</button>
Â  Â  Â  Â  Â  Â  <button onclick="showPage('issuesFeedPage')">View Issue Feed</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="submitIssuePage" class="section-container">
Â  Â  Â  Â  <button class="back-button" onclick="showPage('mainAppPage')">â† Back</button>
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <h2>Report a Civic Issue</h2>
Â  Â  Â  Â  Â  Â  <form id="issueForm">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="description" placeholder="Describe the issue" required>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="location-btn-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="location" placeholder="Your Mandal" readonly required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="getLocation()">ğŸ“</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <select id="category" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Select Category</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Road">Road</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Garbage">Garbage</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Water">Water</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Electricity">Electricity</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <video id="camera" autoplay></video>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="capture-btn-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="capturePhoto()">ğŸ“¸ Capture Photo</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="photoCanvas" style="display:none;"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  <img id="photoPreview" alt="Photo Preview">

Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit">Submit Issue</button>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="issuesFeedPage" class="section-container">
Â  Â  Â  Â  <button class="back-button" onclick="showPage('mainAppPage')">â† Back</button>
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <h2>Approved Issues Feed</h2>
Â  Â  Â  Â  Â  Â  <div id="issuesFeed"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
Â  Â  const API_URL = ''; // This will be set by Vercel

Â  Â  const form = document.getElementById('issueForm');
Â  Â  const feed = document.getElementById('issuesFeed');
Â  Â  const photoPreview = document.getElementById('photoPreview');
Â  Â  const video = document.getElementById('camera');
Â  Â  const canvas = document.getElementById('photoCanvas');

Â  Â  let currentUser = null;
Â  Â  const pages = {
Â  Â  Â  Â  registrationPage: document.getElementById('registrationPage'),
Â  Â  Â  Â  mainAppPage: document.getElementById('mainAppPage'),
Â  Â  Â  Â  submitIssuePage: document.getElementById('submitIssuePage'),
Â  Â  Â  Â  issuesFeedPage: document.getElementById('issuesFeedPage')
Â  Â  };

Â  Â  function showPage(pageId) {
Â  Â  Â  Â  for (const id in pages) {
Â  Â  Â  Â  Â  Â  pages[id].style.display = (id === pageId) ? 'flex' : 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â  if (pageId === 'issuesFeedPage') {
Â  Â  Â  Â  Â  Â  loadApproved();
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  showPage('registrationPage');
Â  Â  Â  Â  navigator.mediaDevices.getUserMedia({ video: true })
Â  Â  Â  Â  Â  Â  .then(stream => { video.srcObject = stream; })
Â  Â  Â  Â  Â  Â  .catch(err => { console.error("Camera access denied:", err); });
Â  Â  });

Â  Â  async function registerUser() {
Â  Â  Â  Â  const username = document.getElementById('usernameInput').value;
Â  Â  Â  Â  const email = document.getElementById('emailInput').value;
Â  Â  Â  Â  const phone = document.getElementById('phoneInput').value;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!username || !email || !phone) {
Â  Â  Â  Â  Â  Â  alert("Please fill in all fields.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch('/api/register', {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ username, email, phone })
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = result.userId;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userNameDisplay').textContent = username;
Â  Â  Â  Â  Â  Â  Â  Â  showPage('mainAppPage');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert(result.message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  alert("Registration failed. Make sure the backend is running.");
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function capturePhoto() {
Â  Â  Â  Â  canvas.width = video.videoWidth;
Â  Â  Â  Â  canvas.height = video.videoHeight;
Â  Â  Â  Â  canvas.getContext('2d').drawImage(video, 0, 0);
Â  Â  Â  Â  photoPreview.src = canvas.toDataURL('image/png');
Â  Â  Â  Â  photoPreview.style.display = "block";
Â  Â  }

Â  Â  let userMandal = "";
Â  Â  async function getLocation() {
Â  Â  Â  Â  if (navigator.geolocation) {
Â  Â  Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(async function(position) {
Â  Â  Â  Â  Â  Â  Â  Â  const lat = position.coords.latitude;
Â  Â  Â  Â  Â  Â  Â  Â  const lon = position.coords.longitude;
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let mandal = data.address.state_district ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data.address.county ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data.address.suburb ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data.address.village ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data.address.town ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â data.address.city || "Unknown";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!mandal.toLowerCase().includes("mandal")) mandal += " Mandal";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userMandal = mandal;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('location').value = userMandal;
Â  Â  Â  Â  Â  Â  Â  Â  } catch(err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('location').value = "Unknown";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Unable to detect Mandal.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, function(error) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Unable to detect location. Please enter manually.");
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert("Geolocation is not supported by this browser.");
Â  Â  Â  Â  }
Â  Â  }

Â  Â  form.addEventListener('submit', async function(e) {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const desc = document.getElementById('description').value;
Â  Â  Â  Â  const loc = document.getElementById('location').value;
Â  Â  Â  Â  const cat = document.getElementById('category').value;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (photoPreview.style.display === "none") {
Â  Â  Â  Â  Â  Â  alert("Please capture a photo before submitting.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  formData.append('description', desc);
Â  Â  Â  Â  formData.append('location', loc);
Â  Â  Â  Â  formData.append('category', cat);
Â  Â  Â  Â  const blob = await (await fetch(photoPreview.src)).blob();
Â  Â  Â  Â  formData.append('photo', blob, 'photo.png');

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch('/api/report', {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  body: formData
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  alert("Issue submitted successfully. Awaiting moderator approval.");
Â  Â  Â  Â  Â  Â  form.reset();
Â  Â  Â  Â  Â  Â  photoPreview.style.display = "none";
Â  Â  Â  Â  Â  Â  showPage('mainAppPage');
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  alert("Failed to submit issue. Make sure the backend is running.");
Â  Â  Â  Â  }
Â  Â  });

Â  Â  async function loadApproved() {
Â  Â  Â  Â  feed.innerHTML = '';
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(`/api/approved`);
Â  Â  Â  Â  Â  Â  let issues = await response.json();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  issues.sort((a, b) => (b.upvotes - b.downvotes) - (a.upvotes - a.downvotes));

Â  Â  Â  Â  Â  Â  if (issues.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  feed.innerHTML = "<p style='text-align: center; color: gray;'>No approved issues yet.</p>";
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  issues.forEach(issue => {
Â  Â  Â  Â  Â  Â  Â  Â  let imgHTML = issue.photo ? `<img src="/uploads/${issue.photo}" alt="Issue Photo">` : '';
Â  Â  Â  Â  Â  Â  Â  Â  feed.innerHTML += `<div class="issue">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>${issue.location}</strong> [${issue.category}]: ${issue.description}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${imgHTML}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="voting-controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="vote('${issue.id}', 'upvote')">ğŸ‘ Upvote (${issue.upvotes})</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="vote('${issue.id}', 'downvote')">ğŸ‘ Downvote (${issue.downvotes})</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch(err) {
Â  Â  Â  Â  Â  Â  console.log("Cannot load approved issues.");
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function vote(id, voteType) {
Â  Â  Â  Â  if (!currentUser) {
Â  Â  Â  Â  Â  Â  alert("Please register to vote.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(`/api/vote/${id}`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ voteType, userId: currentUser })
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  alert(result.message);
Â  Â  Â  Â  Â  Â  loadApproved();
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  alert("Failed to vote. Please check your connection.");
Â  Â  Â  Â  }
Â  Â  }
</script>
</body>
</html>